<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>data.google_views &#8212; NumLock 0.9.9 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=be50ab7b"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for data.google_views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlencode</span>

<span class="c1"># from itsdangerous import URLSafeSerializer</span>
<span class="c1"># serializer = URLSafeSerializer(settings.SECRET_KEY, salt=&quot;google-oauth&quot;)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">signing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">redirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.timezone</span><span class="w"> </span><span class="kn">import</span> <span class="n">now</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">api_view</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">organizations.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Company</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">CloudAccount</span><span class="p">,</span> <span class="n">GoogleOAuthToken</span>

<span class="c1"># from .services.google_api import get_gcp_billing_data, get_gcp_projects</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.services.ingestion</span><span class="w"> </span><span class="kn">import</span> <span class="n">ingest_billing_data</span>

<span class="n">load_dotenv</span><span class="p">()</span>
<span class="c1">#</span>
<span class="c1"># # Environment variables</span>

<span class="n">FRONTEND_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;FRONTEND_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;defaultdomain.com&quot;</span><span class="p">)</span>
<span class="n">GOOGLE_DATA_CLIENT_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GOOGLE_DATA_CLIENT_ID&quot;</span><span class="p">)</span>
<span class="n">GOOGLE_DATA_CLIENT_SECRET</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GOOGLE_DATA_CLIENT_SECRET&quot;</span><span class="p">)</span>
<span class="n">GOOGLE_FAILED_DATA_PULL_REDIRECT_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GOOGLE_DATA_FAILED_REDIRECT_URI&quot;</span><span class="p">)</span>
<span class="n">GOOGLE_DATA_REDIRECT_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GOOGLE_DATA_REDIRECT_URL&quot;</span><span class="p">)</span>
<span class="n">LOGIN_FROM_REDIRECT_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOGIN_FROM_REDIRECT_URL&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="start_google_auth_view">
<a class="viewcode-back" href="../../data.html#data.google_views.start_google_auth_view">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">start_google_auth_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">account_name</span><span class="p">):</span>
    <span class="c1"># company_id = request.GET.get(&quot;company_id&quot;)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">company_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">account_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;company_id and account_name are required&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span>
        <span class="p">)</span>
    <span class="c1"># Sign the state to prevent tampering</span>
    <span class="n">state_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;company_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">company_id</span><span class="p">),</span> <span class="s2">&quot;account_name&quot;</span><span class="p">:</span> <span class="n">account_name</span><span class="p">}</span>
    <span class="n">state_signed</span> <span class="o">=</span> <span class="n">signing</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state_data</span><span class="p">)</span>
    <span class="c1"># Sign the company_id so it can&#39;t be tampered with</span>
    <span class="c1"># state = serializer.dumps({&quot;company_id&quot;: company_id})</span>
    <span class="n">state</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">company_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">account_name</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">GOOGLE_DATA_CLIENT_ID</span><span class="p">,</span>
        <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">GOOGLE_DATA_REDIRECT_URL</span><span class="p">,</span>
        <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;scope&quot;: &quot;https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/cloud-billing.readonly https://www.googleapis.com/auth/bigquery.readonly&quot;,</span>
        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.googleapis.com/auth/cloud-billing.readonly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;access_type&quot;</span><span class="p">:</span> <span class="s2">&quot;offline&quot;</span><span class="p">,</span>  <span class="c1"># to get refresh_token</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;consent&quot;</span><span class="p">,</span>  <span class="c1"># always ask for permission</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state_signed</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://accounts.google.com/o/oauth2/v2/auth?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div>



<div class="viewcode-block" id="google_oauth_callback_view">
<a class="viewcode-back" href="../../data.html#data.google_views.google_oauth_callback_view">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">google_oauth_callback_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
    <span class="n">state_signed</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">state_signed</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">GOOGLE_FAILED_DATA_PULL_REDIRECT_URL</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Verify and decode the signed state</span>
        <span class="n">state_data</span> <span class="o">=</span> <span class="n">signing</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">state_signed</span><span class="p">)</span>
        <span class="n">company_id</span> <span class="o">=</span> <span class="n">state_data</span><span class="p">[</span><span class="s2">&quot;company_id&quot;</span><span class="p">]</span>
        <span class="n">account_name</span> <span class="o">=</span> <span class="n">state_data</span><span class="p">[</span><span class="s2">&quot;account_name&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">signing</span><span class="o">.</span><span class="n">BadSignature</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid state signature&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">token_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">GOOGLE_DATA_CLIENT_ID</span><span class="p">,</span>
        <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">GOOGLE_DATA_CLIENT_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">GOOGLE_DATA_REDIRECT_URL</span><span class="p">,</span>
        <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorization_code&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;https://oauth2.googleapis.com/token&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">token_data</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Token exchange failed&quot;</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span>
        <span class="p">)</span>

    <span class="c1"># Extract token info</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">)</span>
    <span class="n">expires_in</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">]</span>
    <span class="n">expires_at</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">expires_in</span><span class="p">)</span>

    <span class="n">company</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">company_id</span><span class="p">)</span>

    <span class="n">cloud_account</span> <span class="o">=</span> <span class="n">CloudAccount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">company</span><span class="o">=</span><span class="n">company</span><span class="p">,</span>
        <span class="n">vendor</span><span class="o">=</span><span class="s2">&quot;GCP&quot;</span><span class="p">,</span>
        <span class="n">account_name</span><span class="o">=</span><span class="n">account_name</span><span class="p">,</span>
        <span class="n">account_id</span><span class="o">=</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span>  <span class="c1"># will update in fetch view</span>
    <span class="p">)</span>

    <span class="n">GoogleOAuthToken</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">cloud_account</span><span class="o">=</span><span class="n">cloud_account</span><span class="p">,</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">refresh_token</span><span class="o">=</span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="n">expires_at</span><span class="o">=</span><span class="n">expires_at</span><span class="p">,</span>
        <span class="c1"># scope=tokens.get(&quot;scope&quot;),</span>
        <span class="c1"># token_type=tokens.get(&quot;token_type&quot;, &quot;Bearer&quot;),</span>
        <span class="c1"># id_token=tokens.get(&quot;id_token&quot;),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/data/google/fetch/?account_id=</span><span class="si">{</span><span class="n">cloud_account</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1">#</span>
<span class="c1"># @api_view([&quot;GET&quot;])</span>
<span class="c1"># def fetch_google_projects_and_billing_view(request):</span>
<span class="c1">#     account_id = request.GET.get(&quot;account_id&quot;)</span>
<span class="c1">#     cloud_account = CloudAccount.objects.get(id=account_id)</span>
<span class="c1">#     token = cloud_account.google_oauth_token</span>
<span class="c1">#</span>
<span class="c1">#     # Refresh token if expired</span>
<span class="c1">#     if token.is_expired():</span>
<span class="c1">#         token = refresh_google_token(</span>
<span class="c1">#             token, GOOGLE_DATA_CLIENT_ID, GOOGLE_DATA_CLIENT_SECRET</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#     headers = {&quot;Authorization&quot;: f&quot;Bearer {token.access_token}&quot;}</span>
<span class="c1">#</span>
<span class="c1">#     projects_resp = requests.get(</span>
<span class="c1">#         &quot;https://cloudresourcemanager.googleapis.com/v1/projects&quot;, headers=headers</span>
<span class="c1">#     )</span>
<span class="c1">#     projects = projects_resp.json().get(&quot;projects&quot;, [])</span>
<span class="c1">#</span>
<span class="c1">#     for project in projects:</span>
<span class="c1">#         billing_url = f&quot;https://cloudbilling.googleapis.com/v1/projects/{project[&#39;projectId&#39;]}/billingInfo&quot;</span>
<span class="c1">#         billing_resp = requests.get(billing_url, headers=headers)</span>
<span class="c1">#         billing_info = billing_resp.json()</span>
<span class="c1">#</span>
<span class="c1">#         # Store to DB</span>
<span class="c1">#         BillingRecord.objects.create(</span>
<span class="c1">#             cloud_account=cloud_account,</span>
<span class="c1">#             usage_start=now(),  # dummy, replace with actual usage window if available</span>
<span class="c1">#             usage_end=now(),</span>
<span class="c1">#             service_name=&quot;Google Billing&quot;,</span>
<span class="c1">#             resource=project[&quot;projectId&quot;],</span>
<span class="c1">#             cost=0.0,  # Replace with real cost if available</span>
<span class="c1">#             metadata=billing_info,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#     # return JsonResponse({&quot;success&quot;: True, &quot;projects&quot;: projects})</span>
<span class="c1">#     return redirect(f&quot;{FRONTEND_URL}/settings/organization/data&quot;)</span>


<div class="viewcode-block" id="get_gcp_projects">
<a class="viewcode-back" href="../../data.html#data.google_views.get_gcp_projects">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_gcp_projects</span><span class="p">(</span><span class="n">access_token</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://cloudbilling.googleapis.com/v1/billingAccounts&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;billingAccounts&quot;</span><span class="p">,</span> <span class="p">[])</span></div>



<div class="viewcode-block" id="get_gcp_billing_data">
<a class="viewcode-back" href="../../data.html#data.google_views.get_gcp_billing_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_gcp_billing_data</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://cloudbilling.googleapis.com/v1/projects/</span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/billingInfo&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="c1"># Project billing info not found</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>



<div class="viewcode-block" id="fetch_google_projects_and_billing_view">
<a class="viewcode-back" href="../../data.html#data.google_views.fetch_google_projects_and_billing_view">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_google_projects_and_billing_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;account_id&quot;</span><span class="p">)</span>

    <span class="c1"># Get token &amp; account</span>

    <span class="n">cloud_account</span> <span class="o">=</span> <span class="n">CloudAccount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">account_id</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">cloud_account</span><span class="o">.</span><span class="n">google_oauth_token</span>

    <span class="c1"># Refresh token if expired</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">refresh_google_token</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">GOOGLE_DATA_CLIENT_ID</span><span class="p">,</span> <span class="n">GOOGLE_DATA_CLIENT_SECRET</span>
        <span class="p">)</span>

    <span class="c1"># Define date range (last 30 days)</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="c1"># Step 1: Fetch projects</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="n">get_gcp_projects</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">access_token</span><span class="p">)</span>

    <span class="c1"># Step 2: Ingest all billing data</span>
    <span class="n">created_count</span> <span class="o">=</span> <span class="n">ingest_billing_data</span><span class="p">(</span>
        <span class="n">cloud_account</span><span class="o">=</span><span class="n">cloud_account</span><span class="p">,</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">projects</span><span class="o">=</span><span class="n">projects</span><span class="p">,</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
        <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
        <span class="n">get_billing_data_func</span><span class="o">=</span><span class="n">get_gcp_billing_data</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># return Response({&quot;status&quot;: &quot;success&quot;, &quot;records_created&quot;: created_count})</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FRONTEND_URL</span><span class="si">}</span><span class="s2">/settings/organization/data&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="refresh_google_token">
<a class="viewcode-back" href="../../data.html#data.google_views.refresh_google_token">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh_google_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">GoogleOAuthToken</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://oauth2.googleapis.com/token&quot;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
            <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">client_secret</span><span class="p">,</span>
            <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
            <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">token</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
        <span class="n">token</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">])</span>
        <span class="n">token</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scope&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
        <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_type&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span><span class="p">)</span>
        <span class="n">token</span><span class="o">.</span><span class="n">id_token</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id_token&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">id_token</span><span class="p">)</span>
        <span class="n">token</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">token</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to refresh token&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">NumLock</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">cloud-cost-backend</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Natty Y..
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>